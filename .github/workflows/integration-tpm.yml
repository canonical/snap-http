name: Integration Test with TPM and FDE

on:
  workflow_call:
    secrets:
      CI_VM_SSH_KEY:
        required: true

jobs:
  snapd_integration_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            qemu-system-x86 \
            swtpm \
            openssh-client \
            expect \

      - name: download VM image
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSETS=$(gh release view v0.0.0 --repo HJK-X/snap-http --json assets --jq '.assets | sort_by(.name)[] | .name')

          echo "$ASSETS" | while read -r asset; do
            echo "Downloading asset: $asset"
            gh release download v0.0.0 --repo HJK-X/snap-http -p "$asset"
            cat "$asset" >> vm.qcow2
            rm "$asset"
          done

      - name: Create TPM socket
        run: |
          swtpm socket \
            --tpmstate dir=$(pwd)/tests/integration_tpm/assets/swtpm \
            --ctrl type=unixio,path=$(pwd)/tests/integration_tpm/assets/swtpm/swtpm.sock \
            --log level=20 \
            --tpm2 \
            --daemon

      - name: Start QEMU VM
        run: |
          qemu-system-x86_64 \
            -hda vm.qcow2 -m 8192M -smp 2 \
            -usbdevice tablet -vga virtio \
            -chardev socket,id=chrtpm,path=$(pwd)/tests/integration_tpm/assets/swtpm/swtpm.sock \
            -tpmdev emulator,id=tpm0,chardev=chrtpm \
            -device tpm-tis,tpmdev=tpm0 \
            -drive if=pflash,format=raw,unit=0,file=$(pwd)/tests/integration_tpm/assets/OVMF_CODE_4M.ms.fd,readonly=on \
            -drive if=pflash,format=raw,unit=1,file=$(pwd)/tests/integration_tpm/assets/OVMF_VARS_4M_vm.ms.fd \
            -machine q35,smm=on \
            -netdev user,id=netdev1,hostfwd=tcp::2222-:22 \
            -device e1000,netdev=netdev1 \
            -fsdev local,id=fsdev0,path=$(pwd),security_model=none \
            -device virtio-9p-pci,fsdev=fsdev0,mount_tag=hostshare \
            -serial file:vm-console.log \
            -display none \
            -daemonize

      - name: Create SSH key
        run: |
          echo "${{ secrets.CI_VM_SSH_KEY }}" > id_ci
          chmod 600 id_ci

      - name: Wait for SSH
        run: |
          echo "Waiting for VM SSH..."
          for i in {1..30}; do
            if ssh -i id_ci -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -p 2222 a@localhost "echo ready" >/dev/null 2>&1; then
              echo "VM is ready!"
              break
            fi
            sleep 5
          done

      - name: Run integration test
        run: |
          ssh -i id_ci -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -p 2222 a@localhost "
            sudo mkdir -p /mnt/host &&
            mountpoint -q /mnt/host || sudo mount -t 9p -o trans=virtio hostshare /mnt/host &&
            cd /mnt/host/ &&
            sudo poetry install &&
            sudo poetry run pytest tests/integration_tpm
          "

      - name: Shutdown VM
        run: |
          ssh -i id_ci -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -p 2222 a@localhost "sudo shutdown -h now"
          pkill -f swtpm

      - name: Stop VM
        if: always()
        run: |
          pkill -f qemu-system-x86_64 || true
          sleep 2

      - name: Dump VM console log
        if: always()
        run: |
          echo "===== VM CONSOLE LOG ====="
          tail -n 500 vm-console.log || true

